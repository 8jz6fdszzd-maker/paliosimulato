<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il Palio di Siena - Simulazione Storica</title>
    <!-- React e Tailwind caricati da CDN per massima compatibilit√† -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lora:ital,wght@0,400;0,700;1,400&display=swap');
        body { font-family: 'Lora', serif; background-color: #1a0d07; color: #fdfaf3; margin: 0; overflow-x: hidden; height: 100vh; }
        .font-palio { font-family: 'Cinzel', serif; }
        .piazza-sand { 
            background-color: #c59664; 
            background-image: url('https://www.transparenttextures.com/patterns/piazza-tiles.png');
            box-shadow: inset 0 0 40px rgba(0,0,0,0.5);
        }
        .track-container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            position: relative;
        }
        .track-svg { width: 100%; height: auto; display: block; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const CONTRADE = [
            { id: 'aq', name: "Aquila", colors: ["#0000FF", "#000000", "#FFD700", "#FFD700", "#000000", "#0000FF"], emoji: "ü¶Ö" },
            { id: 'br', name: "Bruco", colors: ["#0000FF", "#FFD700", "#FFD700", "#008000", "#008000", "#0000FF"], emoji: "üêõ" },
            { id: 'ch', name: "Chiocciola", colors: ["#0000FF", "#FFD700", "#FFD700", "#FF0000", "#FF0000", "#0000FF"], emoji: "üêå" },
            { id: 'cv', name: "Civetta", colors: ["#FFFFFF", "#FF0000", "#FF0000", "#000000", "#000000", "#FFFFFF"], emoji: "ü¶â" },
            { id: 'dr', name: "Drago", colors: ["#FFD700", "#008000", "#008000", "#FF0000", "#FF0000", "#FFD700"], emoji: "üêâ" },
            { id: 'gi', name: "Giraffa", colors: ["#FFFFFF", "#FFFFFF", "#FFFFFF", "#FF0000", "#FF0000", "#FF0000"], emoji: "ü¶í" },
            { id: 'is', name: "Istrice", colors: ["#FFFFFF", "#0000FF", "#FFFFFF", "#FF0000", "#FFFFFF", "#000000"], emoji: "ü¶î" },
            { id: 'le', name: "Leocorno", colors: ["#0000FF", "#FFFFFF", "#FFFFFF", "#FFA500", "#FFA500", "#0000FF"], emoji: "ü¶Ñ" },
            { id: 'lu', name: "Lupa", colors: ["#FFA500", "#FFFFFF", "#FFFFFF", "#000000", "#000000", "#FFA500"], emoji: "üê∫" },
            { id: 'ni', name: "Nicchio", colors: ["#FFD700", "#FF0000", "#0000FF", "#0000FF", "#FF0000", "#FFD700"], emoji: "üêö" },
            { id: 'oc', name: "Oca", colors: ["#FF0000", "#008000", "#008000", "#FFFFFF", "#FFFFFF", "#FF0000"], emoji: "ü¶Ü" },
            { id: 'on', name: "Onda", colors: ["#FFFFFF", "#FFFFFF", "#FFFFFF", "#87CEEB", "#87CEEB", "#87CEEB"], emoji: "üåä" },
            { id: 'pa', name: "Pantera", colors: ["#FFFFFF", "#0000FF", "#0000FF", "#FF0000", "#FF0000", "#FFFFFF"], emoji: "üêÜ" },
            { id: 'se', name: "Selva", colors: ["#FFFFFF", "#FFA500", "#FFA500", "#008000", "#008000", "#FFFFFF"], emoji: "üå≥" },
            { id: 'ta', name: "Tartuca", colors: ["#FFD700", "#FFD700", "#FFD700", "#0000FF", "#0000FF", "#0000FF"], emoji: "üê¢" },
            { id: 'to', name: "Torre", colors: ["#0000FF", "#FFFFFF", "#8B4513", "#8B4513", "#FFFFFF", "#0000FF"], emoji: "üè∞" },
            { id: 'va', name: "Valdimontone", colors: ["#FFFFFF", "#FFD700", "#FFD700", "#FF0000", "#FF0000", "#FFFFFF"], emoji: "üêè" }
        ];

        const FANTINI = ["Tittia", "Gingillo", "Scompiglio", "Brio", "Trecciolino", "Amsicora", "Brigante", "Turbine", "Tempesta", "Scangeo"];

        function App() {
            const [year, setYear] = useState(2026);
            const [palioType, setPalioType] = useState('Luglio');
            const [alboDOro, setAlboDOro] = useState([]);
            const [step, setStep] = useState('menu');
            const [participants, setParticipants] = useState([]);
            const [horses, setHorses] = useState({});
            const [jockeys, setJockeys] = useState({});
            const [racingSet, setRacingSet] = useState([]);
            const [isRacing, setIsRacing] = useState(false);
            const [winner, setWinner] = useState(null);
            const requestRef = useRef();

            const startPalio = () => {
                const selected = [...CONTRADE].sort(() => 0.5 - Math.random()).slice(0, 10);
                setParticipants(selected);
                setStep('draw_results');
            };

            const assignHorses = () => {
                const h = {};
                participants.forEach(p => h[p.id] = Math.floor(Math.random() * 5) + 1);
                setHorses(h);
                setStep('tratta_horses');
            };

            const assignJockeys = () => {
                const j = {};
                const availableNames = [...FANTINI].sort(() => 0.5 - Math.random());
                participants.forEach((p, idx) => {
                    j[p.id] = { name: availableNames[idx] || "Fantino", skill: Math.floor(Math.random() * 5) + 1 };
                });
                setJockeys(j);
                setStep('tratta_jockeys');
            };

            const setupRace = () => {
                const data = participants.map((p, i) => ({
                    ...p, progress: 0, laps: 0, lane: i, isScosso: false,
                    baseSpeed: 0.00045 + (horses[p.id] * 0.00004) + (jockeys[p.id].skill * 0.00001)
                }));
                setRacingSet(data);
                setStep('race');
                setIsRacing(false);
                setWinner(null);
            };

            const update = useCallback(() => {
                if (!isRacing) return;
                setRacingSet(prev => {
                    let win = null;
                    const next = prev.map(c => {
                        if (c.laps >= 3) return c;
                        let s = c.baseSpeed + (Math.random() - 0.48) * 0.00022;
                        const inCurve = (c.progress > 0.3 && c.progress < 0.45) || (c.progress > 0.8 && c.progress < 0.95);
                        if (inCurve) {
                            s *= 0.72;
                            if (!c.isScosso && Math.random() > 0.9997) c.isScosso = true;
                        }
                        let nP = c.progress + s;
                        let nL = c.laps;
                        if (nP >= 1) { nP = 0; nL++; }
                        if (nL >= 3 && !win) win = c;
                        return { ...c, progress: nP, laps: nL };
                    });
                    if (win) {
                        setWinner(win);
                        setIsRacing(false);
                        setAlboDOro(prevAlbo => [{ year, type: palioType, winner: win }, ...prevAlbo]);
                    }
                    return next;
                });
                requestRef.current = requestAnimationFrame(update);
            }, [isRacing, year, palioType]);

            useEffect(() => {
                if (isRacing) requestRef.current = requestAnimationFrame(update);
                return () => cancelAnimationFrame(requestRef.current);
            }, [isRacing, update]);

            const getPos = (progress, lane) => {
                const angle = progress * Math.PI * 2 - Math.PI / 2;
                const rx = 160 + (lane * 6.5);
                const ry = 110 + (lane * 4.5); 
                return {
                    x: 250 + (rx * Math.cos(angle)), 
                    y: 200 + (ry * Math.sin(angle)) 
                };
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    <div className="w-full max-w-xl bg-black/80 p-6 rounded-3xl border border-yellow-900/40 flex justify-between items-center mb-6 shadow-2xl">
                        <div>
                            <h1 className="text-3xl font-palio font-black text-yellow-500 italic leading-none">{year}</h1>
                            <p className="text-xs uppercase tracking-widest text-white/50">{palioType}</p>
                        </div>
                        <button onClick={() => setStep('albo')} className="bg-yellow-900/40 px-4 py-2 rounded-xl border border-yellow-600/20 text-xs font-bold uppercase">Albo d'Oro</button>
                    </div>

                    {step === 'menu' && (
                        <div className="flex flex-col gap-8 w-full max-w-xs mt-12 text-center">
                            <h3 className="text-2xl font-black uppercase text-yellow-600 italic tracking-widest">Siena, Piazza del Campo</h3>
                            <button onClick={startPalio} className="p-16 bg-red-950 border-4 border-yellow-700 rounded-[60px] shadow-2xl hover:scale-105 transition active:scale-95">
                                <span className="text-4xl block font-palio font-black text-white">SORTEGGIO</span>
                            </button>
                        </div>
                    )}

                    {step === 'draw_results' && (
                        <div className="w-full max-w-lg space-y-4">
                            <div className="grid grid-cols-2 gap-3">
                                {participants.map(c => (
                                    <div key={c.id} className="p-4 rounded-2xl bg-white/5 border border-white/10 flex items-center gap-3">
                                        <div className="text-2xl">{c.emoji}</div>
                                        <span className="font-black uppercase text-sm tracking-tight">{c.name}</span>
                                    </div>
                                ))}
                            </div>
                            <button onClick={assignHorses} className="w-full py-5 bg-yellow-600 text-black font-black rounded-2xl uppercase font-palio shadow-xl">Assegnazione Cavalli</button>
                        </div>
                    )}

                    {step === 'tratta_horses' && (
                        <div className="w-full max-w-sm space-y-3">
                            {participants.map(c => (
                                <div key={c.id} className="p-4 rounded-2xl bg-white/5 flex justify-between items-center border border-white/5">
                                    <span className="font-black uppercase text-sm">{c.name}</span>
                                    <span className="text-xl">{'üêé'.repeat(horses[c.id])}</span>
                                </div>
                            ))}
                            <button onClick={assignJockeys} className="w-full mt-6 py-5 bg-red-800 text-white font-black rounded-2xl uppercase font-palio">Segnatura Fantini</button>
                        </div>
                    )}

                    {step === 'tratta_jockeys' && (
                        <div className="w-full max-w-sm space-y-2">
                            {participants.map(c => (
                                <div key={c.id} className="p-3 rounded-2xl bg-white/5 border border-white/5 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <div className="text-2xl">{c.emoji}</div>
                                        <div>
                                            <div className="font-black uppercase text-xs">{c.name}</div>
                                            <div className="text-[10px] text-yellow-500 font-bold uppercase">{jockeys[c.id].name}</div>
                                        </div>
                                    </div>
                                    <div className="text-xs opacity-50 font-mono">{(horses[c.id] + jockeys[c.id].skill)/2} ‚òÖ</div>
                                </div>
                            ))}
                            <button onClick={setupRace} className="w-full mt-6 py-6 bg-yellow-600 text-black font-black rounded-2xl uppercase font-palio text-xl">Vai in Piazza</button>
                        </div>
                    )}

                    {step === 'race' && (
                        <div className="w-full flex flex-col items-center">
                            <div className="h-8 mb-4 text-yellow-500 font-black italic text-sm uppercase tracking-widest">
                                {!isRacing && !winner ? "Attesa della Mossa..." : winner ? "PALIO FINITO" : "CORSA IN CORSO"}
                            </div>
                            <div className="track-container">
                                <div className="piazza-sand rounded-[50px] border-8 border-[#3a2215] overflow-hidden shadow-2xl">
                                    <svg viewBox="0 0 500 400" className="track-svg">
                                        <ellipse cx="250" cy="200" rx="195" ry="135" fill="none" stroke="rgba(0,0,0,0.1)" strokeWidth="45" />
                                        {racingSet.map((c, i) => {
                                            const pos = getPos(c.progress, i);
                                            return (
                                                <g key={c.id} transform={`translate(${pos.x}, ${pos.y})`}>
                                                    <circle r="10" fill="black" opacity="0.2" transform="translate(1, 1)" />
                                                    <circle r="9" fill={c.colors[0]} stroke="#fff" strokeWidth="1.5" />
                                                    <text fontSize="10" dy="3.5" textAnchor="middle">{c.isScosso ? 'üêé' : 'üèá'}</text>
                                                </g>
                                            );
                                        })}
                                        <line x1="250" y1="20" x2="250" y2="70" stroke="white" strokeWidth="3" strokeDasharray="5" opacity="0.5" />
                                    </svg>
                                </div>
                            </div>
                            {!isRacing && !winner && (
                                <button onClick={() => setIsRacing(true)} className="w-full max-w-xs mt-10 py-6 bg-red-800 text-white font-black text-3xl rounded-3xl shadow-2xl uppercase font-palio transform hover:scale-105 active:scale-95 transition">Mossa!</button>
                            )}
                        </div>
                    )}

                    {winner && (
                        <div className="fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-8 text-center animate-in">
                            <div className="text-yellow-500 font-palio text-sm tracking-[0.4em] mb-6 uppercase italic">Siena trionfa!</div>
                            <div className="text-9xl mb-8 drop-shadow-[0_0_50px_rgba(234,179,8,0.5)]">{winner.emoji}</div>
                            <h2 className="text-6xl font-black italic uppercase font-palio text-white">{winner.name}</h2>
                            <p className="mt-4 text-yellow-600 font-bold italic text-2xl">{palioType} {year}</p>
                            <button onClick={() => {
                                if (palioType === 'Luglio') setPalioType('Agosto');
                                else { setYear(y => y + 1); setPalioType('Luglio'); }
                                setWinner(null);
                                setStep('menu');
                            }} className="mt-12 py-5 px-12 bg-yellow-600 text-black font-black rounded-full uppercase font-palio text-xl">Continua</button>
                        </div>
                    )}

                    {step === 'albo' && (
                        <div className="fixed inset-0 z-50 bg-[#1a0d07] p-8 overflow-y-auto">
                            <div className="max-w-md mx-auto">
                                <h2 className="text-3xl font-palio text-yellow-500 text-center mb-10 uppercase italic tracking-widest border-b border-yellow-900/30 pb-4">Albo d'Oro</h2>
                                {alboDOro.length === 0 ? (
                                    <p className="text-center opacity-40 italic">La storia deve ancora essere scritta...</p>
                                ) : (
                                    <div className="space-y-4">
                                        {alboDOro.map((entry, idx) => (
                                            <div key={idx} className="flex items-center justify-between bg-white/5 p-5 rounded-2xl border border-white/5">
                                                <div>
                                                    <span className="text-[10px] text-yellow-600 font-bold uppercase tracking-widest">{entry.type} {entry.year}</span>
                                                    <div className="text-xl font-black font-palio uppercase text-white">{entry.winner.name}</div>
                                                </div>
                                                <div className="text-4xl">{entry.winner.emoji}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <button onClick={() => setStep(winner ? 'race' : 'menu')} className="w-full mt-12 py-5 bg-yellow-600 text-black font-black rounded-2xl uppercase font-palio">Chiudi Albo</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

